<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>üåø Selecci√≥n de Planta IoT</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #e8f5e9;
      text-align: center;
      padding: 40px;
    }
    input, button {
      padding: 10px;
      font-size: 16px;
      margin: 10px;
    }
    #result {
      margin-top: 30px;
      padding: 20px;
      background-color: #ffffff;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
      text-align: left;
    }
    img {
      max-width: 100%;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <h1>üåø Buscador de Plantas IoT</h1>
  <input type="text" id="plantName" placeholder="Ej: orchid, aloe, bigleaf hydrangea">
  <button onclick="buscarPlanta()">Buscar</button>
  <div id="result"></div>

  <!-- MQTT LIB -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.1.0/mqttws31.min.js"></script>

  <script>
    // MQTT Config
    let client = new Paho.MQTT.Client("192.168.203.1", 9001, "web_" + Math.random());
    client.connect({
      onSuccess: () => console.log("‚úÖ Conectado al broker MQTT"),
      onFailure: (e) => console.error("‚ùå Error MQTT:", e.errorMessage),
      useSSL: false
    });

    function buscarPlanta() {
      const nombre = document.getElementById("plantName").value.trim().toLowerCase();
      const result = document.getElementById("result");
      result.innerHTML = "üîç Buscando planta...";

      const apiKey = "sk-SPJk681700e00204010216";
      const url = `https://perenual.com/api/species-list?key=${apiKey}&q=${encodeURIComponent(nombre)}`;

      fetch(url)
        .then(res => res.json())
        .then(data => {
          if (!data.data || data.data.length === 0) {
            result.innerHTML = "‚ùå Planta no encontrada.";
            return;
          }

          const planta = data.data[0];
          const imagen = planta.default_image?.original_url || "https://via.placeholder.com/300x200?text=Sin+Imagen";

          result.innerHTML = `
            <h2>${planta.common_name || "Sin nombre com√∫n"}</h2>
            <img src="${imagen}" alt="Imagen de planta">
            <p><strong>Nombre cient√≠fico:</strong> ${planta.scientific_name}</p>
            <p><strong>Riego:</strong> ${planta.watering || "No disponible"}</p>
            <p><strong>Luz:</strong> ${Array.isArray(planta.sunlight) ? planta.sunlight.join(", ") : planta.sunlight || "No disponible"}</p>
            <p><strong>Descripci√≥n:</strong> ${planta.description || "No disponible"}</p>
          `;

          // Publicar por MQTT
          const payload = {
            nombre: planta.common_name || "Sin nombre",
            riego: planta.watering || "N/A",
            luz: planta.sunlight || [],
            temperatura: planta.ideal_light || "N/A"
          };

          if (client.isConnected()) {
            const message = new Paho.MQTT.Message(JSON.stringify(payload));
            message.destinationName = "planta/seleccion";
            client.send(message);
            console.log("üì§ Enviado a ESP32:", payload);
          } else {
            console.warn("‚ö†Ô∏è MQTT no conectado");
          }
        })
        .catch(err => {
          console.error("‚ùå Error en API:", err);
          result.innerHTML = "‚ùå Error al obtener datos.";
        });
    }
  </script>
</body>
</html>

